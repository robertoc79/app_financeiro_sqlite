<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Financeiro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h2>Bem-vindo, {{ usuario }}!</h2>
        <h3>ðŸ’° Saldo atual: R$ {{ "%.2f"|format(saldo) }}</h3>

        <form action="{{ url_for('add_transacao') }}" method="POST">
            <input type="text" name="descricao" placeholder="DescriÃ§Ã£o" required>
            <input type="number" step="0.01" name="valor" placeholder="Valor" required>
            <select name="tipo">
                <option value="entrada">Entrada</option>
                <option value="saida">SaÃ­da</option>
            </select>
            <button type="submit">Adicionar</button>
        </form>

        <table>
            <tr>
                <th>DescriÃ§Ã£o</th>
                <th>Valor (R$)</th>
                <th>Tipo</th>
                <th>Data</th>
                <th>AÃ§Ãµes</th>
            </tr>
            {% for t in transacoes %}
            <tr>
                <td>{{ t.descricao }}</td>
                <td>{{ "%.2f"|format(t.valor) }}</td>
                <td>{% if t.tipo == 'entrada' %}ðŸŸ¢ Entrada{% else %}ðŸ”´ SaÃ­da{% endif %}</td>
                <td>{{ t.data.strftime("%d/%m/%Y %H:%M") if t.data else '' }}</td>
                <td>
                    <a href="{{ url_for('editar', id=t.id) }}" class="btn-yellow">Editar</a>
                    <a href="{{ url_for('excluir', id=t.id) }}" class="btn-red">Excluir</a>
                </td>
            </tr>
            {% endfor %}
        </table>

        <div style="margin-top: 40px;">
            <h3>ðŸ“Š GrÃ¡fico de Entradas vs SaÃ­das</h3>
            <canvas id="graficoPizza"></canvas>
        </div>

        <div style="margin-top: 40px;">
            <h3>ðŸ“ˆ EvoluÃ§Ã£o do Saldo</h3>
            <canvas id="graficoLinha"></canvas>
        </div>

        <a href="{{ url_for('logout') }}" class="btn-blue">Sair</a>
    </div>

    <script>
        const transacoes = JSON.parse('{{ transacoes|tojson|safe }}');
        const entradas = transacoes.filter(t => t.tipo === 'entrada').reduce((acc, t) => acc + parseFloat(t.valor), 0);
        const saidas = transacoes.filter(t => t.tipo === 'saida').reduce((acc, t) => acc + parseFloat(t.valor), 0);

        new Chart(document.getElementById('graficoPizza'), {
            type: 'pie',
            data: {
                labels: ['Entradas', 'SaÃ­das'],
                datasets: [{
                    data: [entradas, saidas],
                    backgroundColor: ['#4CAF50', '#F44336']
                }]
            },
            options: { responsive: true }
        });

        const datas = transacoes.map(t => new Date(t.data).toLocaleDateString('pt-BR'));
        const saldos = [];
        let acumulado = 0;
        for (const t of transacoes) {
            acumulado += t.tipo === 'entrada' ? parseFloat(t.valor) : -parseFloat(t.valor);
            saldos.push(acumulado);
        }

        new Chart(document.getElementById('graficoLinha'), {
            type: 'line',
            data: {
                labels: datas,
                datasets: [{
                    label: 'Saldo (R$)',
                    data: saldos,
                    borderColor: '#2196F3',
                    fill: false
                }]
            },
            options: { responsive: true }
        });
    </script>
</body>
</html>
